<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zo√™</title>

<style>
*{ box-sizing:border-box; }
body{
  margin:0;
  background:#e5e7eb;
  display:flex;
  justify-content:center;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
.phone{
  width:100%;
  max-width:420px;
  min-height:100vh;
  background:#f8fafc;
  position:relative;
}
header{
  background:#22c55e;
  color:#fff;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
}
header button{
  background:#fff;
  color:#22c55e;
  border:none;
  padding:6px 14px;
  border-radius:18px;
  font-weight:600;
  cursor:pointer;
}
main{ padding:16px; }
.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.card img{
  width:100%;
  border-radius:12px;
  margin-bottom:10px;
}
.btn{
  background:#f97316;
  color:#fff;
  border:none;
  padding:12px;
  width:100%;
  border-radius:12px;
  margin-top:10px;
  cursor:pointer;
  font-weight:600;
}
.btn.green{ background:#22c55e; }
.btn.blue{ background:#2563eb; }
.btn.gray{ background:#e5e7eb; color:#111; }

.progress{
  background:#e5e7eb;
  height:8px;
  border-radius:8px;
  overflow:hidden;
  margin-top:6px;
}
.progress-fill{
  background:#22c55e;
  height:100%;
}

.value-buttons{
  display:flex;
  gap:8px;
  margin:10px 0;
}
.value-buttons button{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:2px solid #22c55e;
  background:#fff;
  color:#22c55e;
  font-weight:600;
}
.value-buttons button.active{
  background:#22c55e;
  color:#fff;
}

input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-top:8px;
}

.nav{
  position:absolute;
  top:60px;
  right:16px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  display:none;
  flex-direction:column;
  min-width:180px;
  z-index:999;
}
.nav div{
  padding:14px 16px;
  cursor:pointer;
  border-bottom:1px solid #eee;
}
.nav div:last-child{ border-bottom:none; }

.ia-list{
  list-style:none;
  padding:0;
  margin-top:12px;
}
.ia-list li{
  background:#f0fdfa;
  color:#065f46;
  padding:10px 12px;
  border-radius:10px;
  font-size:14px;
  margin-bottom:8px;
}
</style>
</head>

<body>
<div class="phone">

<header>
  <span>Zo√™</span>
  <button onclick="toggleMenu()">‚ò∞</button>
</header>

<main id="screen"></main>
<div id="paymentScreen" style="display:none;padding:16px;"></div>

<div class="nav" id="menu">
  <div onclick="renderHome()">In√≠cio</div>
  <div onclick="renderDonations()">Doa√ß√µes</div>
  <div onclick="renderTransparency()">Transpar√™ncia</div>
  <div onclick="renderProfile()">Perfil</div>
  <div onclick="logout()" style="color:#dc2626;font-weight:600">Sair</div>
</div>

<script>
const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
const cpfUsuario = localStorage.getItem("cpfUsuario") || "N√£o informado";
if(!usuario){ location.href="index.html"; }

function toggleMenu(){
  const m=document.getElementById("menu");
  m.style.display=m.style.display==="flex"?"none":"flex";
}
function logout(){
  localStorage.removeItem("usuarioLogado");
  location.href="index.html";
}

/* FAM√çLIAS */
const families=[
  {name:"Fam√≠lia Silva",image:"assets/familia1.jpeg",goal:1800},
  {name:"Fam√≠lia Pereira",image:"assets/familia2.jpeg",goal:900},
  {name:"Fam√≠lia Rocha",image:"assets/familia3.jpeg",goal:1500},
  {name:"Fam√≠lia do Amor",image:"assets/familia4.jpeg",goal:2000},
  {name:"Fam√≠lia Santos",image:"assets/familia5.jpeg",goal:1200},
  {name:"Fam√≠lia Ferreira",image:"assets/familia6.jpeg",goal:1800},
  {name:"Fam√≠lia Nunes",image:"assets/familia7.jpeg",goal:900},
  {name:"Fam√≠lia Costa",image:"assets/familia8.jpeg",goal:1600},
  {name:"Fam√≠lia Lima",image:"assets/familia9.jpeg",goal:1400}
];

let relatorio = JSON.parse(localStorage.getItem("relatorio")) || [];
let repasses  = JSON.parse(localStorage.getItem("repasses")) || [];
let familiaAtual="";
let valorSelecionado=0;

/* TELAS PRINCIPAIS */
function totalArrecadadoPorFamilia(nome){
  return relatorio.filter(d=>d.familia===nome)
    .reduce((s,d)=>s+Number(d.valor),0);
}

function renderHome(){
  document.getElementById("menu").style.display="none";
  document.getElementById("paymentScreen").style.display="none";
  const s=document.getElementById("screen");
  s.style.display="block";

  s.innerHTML=`<div class="card"><h3>Bem-vindo(a)!</h3></div>`;

  families.forEach(f=>{
    const arrec=totalArrecadadoPorFamilia(f.name);
    const percent=Math.min((arrec/f.goal)*100,100);

    s.innerHTML+=`
      <div class="card">
        <img src="${f.image}">
        <strong>${f.name}</strong>
        <p>R$ ${arrec.toFixed(2)} / R$ ${f.goal}</p>
        <div class="progress">
          <div class="progress-fill" style="width:${percent}%"></div>
        </div>
        <button class="btn" onclick="abrirPagamento('${f.name}')">
          Apadrinhar
        </button>
      </div>`;
  });
}

function renderDonations(){
  document.getElementById("menu").style.display="none";
  document.getElementById("screen").innerHTML=
    `<div class="card"><h3>Doa√ß√µes</h3><p>Consulte o hist√≥rico na Transpar√™ncia.</p></div>`;
}

function renderProfile(){
  document.getElementById("menu").style.display="none";
  document.getElementById("screen").innerHTML=`
    <div class="card">
      <h3>Meu Perfil</h3>
      <p>Email: ${usuario.email}</p>
      <p>CPF: ${cpfUsuario}</p>
      <button class="btn gray" onclick="renderHome()">‚Üê Voltar</button>
    </div>`;
}

/* TRANSPAR√äNCIA */
function renderTransparency(){
  document.getElementById("menu").style.display="none";
  document.getElementById("paymentScreen").style.display="none";

  document.getElementById("screen").innerHTML=`
    <div class="card">
      <h3>Transpar√™ncia</h3>
      <button class="btn green" onclick="abrirSecaoRelatorio()">üìä Se√ß√£o de relat√≥rio</button>
    </div>

    <div class="card">
      <h3>Apoio da IA</h3>
      <p>
        Os dados apresentados nesta plataforma s√£o organizados e analisados
        automaticamente pelo sistema, com apoio de processos inteligentes
        voltados √† transpar√™ncia e √† integridade das informa√ß√µes.
      </p>
      <ul class="ia-list">
        <li>Organiza√ß√£o e padroniza√ß√£o dos dados registrados</li>
        <li>Consolida√ß√£o autom√°tica das informa√ß√µes financeiras</li>
        <li>Classifica√ß√£o e s√≠ntese dos dados por fam√≠lia e per√≠odo</li>
        <li>An√°lise comparativa entre valores arrecadados, metas e repasses</li>
        <li>Identifica√ß√£o autom√°tica de poss√≠veis inconsist√™ncias</li>
        <li>Gera√ß√£o de resumo institucional para acompanhamento e auditoria</li>
      </ul>
    </div>`;
}

function abrirSecaoRelatorio(){
  document.getElementById("screen").innerHTML=`
    <div class="card">
      <h3>Relat√≥rios</h3>
      <button class="btn blue" onclick="emitirPDF()">üìÑ Emitir PDF de Doa√ß√µes</button>
      <button class="btn green" onclick="emitirPDFRepasses()">üí∞ Emitir PDF de Repasses</button>
      <button class="btn gray" onclick="renderTransparency()">‚Üê Voltar</button>
    </div>`;
}

/* PAGAMENTO (PIX E CART√ÉO) */
function abrirPagamento(nome){
  familiaAtual=nome;
  valorSelecionado=0;

  document.getElementById("screen").style.display="none";
  const p=document.getElementById("paymentScreen");
  p.style.display="block";

  p.innerHTML=`
    <div class="card">
      <h3>Forma de pagamento</h3>
      <p>${nome}</p>
      <button class="btn green" onclick="abrirPix()">üíö Pix</button>
      <button class="btn blue" onclick="abrirCartao()">üí≥ Cart√£o</button>
      <button class="btn gray" onclick="renderHome()">‚Üê Voltar</button>
    </div>`;
}

function abrirPix(){
  valorSelecionado=0;
  document.getElementById("paymentScreen").innerHTML=`
    <div class="card">
      <h3>Pix</h3>
      <div class="value-buttons">
        <button onclick="setValor(10,this)">R$ 10</button>
        <button onclick="setValor(50,this)">R$ 50</button>
        <button onclick="setValor(100,this)">R$ 100</button>
      </div>
      <input id="valorInput" type="number"
        placeholder="Outro valor"
        oninput="setValor(this.value)">
      <button class="btn green" onclick="gerarPix()">Fazer pagamento</button>
    </div>`;
}

function setValor(v,btn=null){
  valorSelecionado=Number(v)||0;
  const i=document.getElementById("valorInput");
  if(i) i.value=valorSelecionado||"";
  document.querySelectorAll(".value-buttons button")
    .forEach(b=>b.classList.remove("active"));
  if(btn) btn.classList.add("active");
}

function gerarPix(){
  if(valorSelecionado<=0){ alert("Informe um valor"); return; }
  document.getElementById("paymentScreen").innerHTML=`
    <div class="card" style="text-align:center">
      <h3>PIX</h3>
      <img src="assets/qrcode-pix.jpg" style="width:220px;margin:16px auto">
      <button class="btn green"
        onclick="registrarDoacao('Pix');sucesso()">
        J√° paguei
      </button>
    </div>`;
}

function abrirCartao(){
  valorSelecionado=0;
  document.getElementById("paymentScreen").innerHTML=`
    <div class="card">
      <h3>Pagamento com Cart√£o</h3>
      <input type="number" placeholder="Valor da doa√ß√£o (R$)"
        oninput="valorSelecionado=this.value">
      <input type="text" placeholder="N√∫mero do cart√£o">
      <input type="text" placeholder="Nome no cart√£o">
      <div style="display:flex;gap:8px">
        <input type="text" placeholder="Validade (MM/AA)">
        <input type="text" placeholder="CVV" maxlength="4">
      </div>
      <button class="btn blue" onclick="confirmarCartao()">Confirmar pagamento</button>
      <button class="btn gray" onclick="abrirPagamento('${familiaAtual}')">‚Üê Voltar</button>
    </div>`;
}

function confirmarCartao(){
  if(valorSelecionado<=0){
    alert("Informe um valor v√°lido");
    return;
  }
  document.getElementById("paymentScreen").innerHTML=
    `<div class="card" style="text-align:center">Processando pagamento...</div>`;
  setTimeout(()=>{
    registrarDoacao("Cart√£o");
    sucesso();
  },1200);
}

/* REGISTRO */
function registrarDoacao(forma){
  relatorio.push({
    nome: usuario.email.split("@")[0],
    email: usuario.email,
    cpf: cpfUsuario,
    familia: familiaAtual,
    valor: valorSelecionado,
    forma,
    data: new Date().toLocaleString("pt-BR")
  });
  localStorage.setItem("relatorio",JSON.stringify(relatorio));
}

function sucesso(){
  document.getElementById("paymentScreen").innerHTML=
    `<div class="card" style="text-align:center">‚ù§Ô∏è Obrigado pela doa√ß√£o!</div>`;
  setTimeout(renderHome,1500);
}

/* ===== PDFs (CORRIGIDOS) ===== */
function emitirPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;

  pdf.setFontSize(16);
  pdf.text("Relat√≥rio de Doa√ß√µes - Zo√™",10,y);
  y+=10;

  if(relatorio.length===0){
    pdf.text("Nenhuma doa√ß√£o registrada.",10,y);
  }else{
    relatorio.forEach(d=>{
      pdf.setFontSize(12);
      pdf.text(`Fam√≠lia: ${d.familia}`,10,y); y+=6;
      pdf.text(`Valor: R$ ${Number(d.valor).toFixed(2)}`,10,y); y+=6;
      pdf.text(`Forma: ${d.forma}`,10,y); y+=6;
      pdf.text(`Data: ${d.data}`,10,y); y+=8;
      if(y>270){ pdf.addPage(); y=10; }
    });
  }

  pdf.save("relatorio-doacoes-zoe.pdf");
}

function emitirPDFRepasses(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;

  pdf.setFontSize(16);
  pdf.text("Relat√≥rio de Repasses - Zo√™",10,y);
  y+=10;

  if(repasses.length===0){
    pdf.text("Nenhum repasse registrado.",10,y);
  }else{
    repasses.forEach(r=>{
      pdf.setFontSize(12);
      pdf.text(`Fam√≠lia: ${r.familia}`,10,y); y+=6;
      pdf.text(`Valor: R$ ${Number(r.valor).toFixed(2)}`,10,y); y+=6;
      pdf.text(`Data/Hora: ${r.dataHora || "-"}`,10,y); y+=8;
      if(y>270){ pdf.addPage(); y=10; }
    });
  }

  pdf.save("relatorio-repasses-zoe.pdf");
}

renderHome();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</div>
</body>
</html>
