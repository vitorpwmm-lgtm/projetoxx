<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zo√™</title>

<style>
*{ box-sizing:border-box; }
body{
  margin:0;
  background:#e5e7eb;
  display:flex;
  justify-content:center;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
.phone{
  width:100%;
  max-width:420px;
  min-height:100vh;
  background:#f8fafc;
  position:relative;
}
header{
  background:#22c55e;
  color:#fff;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
}
header button{
  background:#fff;
  color:#22c55e;
  border:none;
  padding:6px 14px;
  border-radius:18px;
  font-weight:600;
  cursor:pointer;
}
main{ padding:16px; }
.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.card img{
  width:100%;
  border-radius:12px;
  margin-bottom:10px;
}
.btn{
  background:#f97316;
  color:#fff;
  border:none;
  padding:12px;
  width:100%;
  border-radius:12px;
  margin-top:10px;
  cursor:pointer;
  font-weight:600;
}
.btn.green{ background:#22c55e; }
.btn.blue{ background:#2563eb; }
.btn.gray{ background:#e5e7eb; color:#111; }
.progress{
  background:#e5e7eb;
  height:8px;
  border-radius:8px;
  overflow:hidden;
  margin-top:6px;
}
.progress-fill{
  background:#22c55e;
  height:100%;
}
.value-buttons{
  display:flex;
  gap:8px;
  margin:10px 0;
}
.value-buttons button{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:2px solid #22c55e;
  background:#fff;
  color:#22c55e;
  font-weight:600;
}
.value-buttons button.active{
  background:#22c55e;
  color:#fff;
}
input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-top:8px;
}
.nav{
  position:absolute;
  top:60px;
  right:16px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  display:none;
  flex-direction:column;
  min-width:180px;
  z-index:999;
}
.nav div{
  padding:14px 16px;
  cursor:pointer;
  border-bottom:1px solid #eee;
}
.nav div:last-child{ border-bottom:none; }
</style>
</head>

<body>
<div class="phone">

<header>
  <span>Zo√™</span>
  <button onclick="toggleMenu()">‚ò∞</button>
</header>

<main id="screen"></main>
<div id="paymentScreen" style="display:none;padding:16px;"></div>

<div class="nav" id="menu">
  <div onclick="renderHome()">In√≠cio</div>
  <div onclick="renderDonations()">Doa√ß√µes</div>
  <div onclick="renderTransparency()">Transpar√™ncia</div>
  <div onclick="renderProfile()">Perfil</div>
  <div onclick="logout()" style="color:#dc2626;font-weight:600">Sair</div>
</div>

<script>
// ===== LOGIN =====
const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
const tipoCadastro = localStorage.getItem("tipoCadastro");
const cpfUsuario = localStorage.getItem("cpfUsuario") || "N√£o informado";

if(!usuario){
  location.href="index.html";
}

// ===== MENU =====
function toggleMenu(){
  const m=document.getElementById("menu");
  m.style.display=m.style.display==="flex"?"none":"flex";
}
function logout(){
  localStorage.removeItem("usuarioLogado");
  location.href="index.html";
}

// ===== FAM√çLIAS =====
const families = [
  { name:"Fam√≠lia Silva", image:"assets/familia1.jpeg", goal:1800, raised:720 },
  { name:"Fam√≠lia Pereira", image:"assets/familia2.jpeg", goal:900, raised:300 },
  { name:"Fam√≠lia Rocha", image:"assets/familia3.jpeg", goal:1500, raised:0 },
  { name:"Fam√≠lia do Amor", image:"assets/familia4.jpeg", goal:2000, raised:0 },
  { name:"Fam√≠lia Santos", image:"assets/familia5.jpeg", goal:1200, raised:0 },
  { name:"Fam√≠lia Ferreira", image:"assets/familia6.jpeg", goal:1800, raised:0 },
  { name:"Fam√≠lia Nunes", image:"assets/familia7.jpeg", goal:900, raised:0 },
  { name:"Fam√≠lia Costa", image:"assets/familia8.jpeg", goal:1600, raised:0 },
  { name:"Fam√≠lia Lima", image:"assets/familia9.jpeg", goal:1400, raised:0 }
];

// ===== DADOS =====
let relatorio = JSON.parse(localStorage.getItem("relatorio")) || [];
let repasses = JSON.parse(localStorage.getItem("repasses")) || [];

let familiaAtual="";
let valorSelecionado=0;

// ===== REGISTRO DE DOA√á√ÉO =====
function registrarDoacao(forma){
  relatorio.push({
    nome: usuario.email.split("@")[0],
    email: usuario.email,
    cpf: cpfUsuario,
    familia: familiaAtual,
    valor: valorSelecionado,
    forma,
    data: new Date().toLocaleString("pt-BR")
  });
  localStorage.setItem("relatorio", JSON.stringify(relatorio));
}

// ===== C√ÅLCULOS =====
function totalArrecadadoPorFamilia(nome){
  return relatorio.filter(d => d.familia === nome)
    .reduce((s,d)=>s+Number(d.valor),0);
}
function totalRepassadoPorFamilia(nome){
  return repasses.filter(r => r.familia === nome)
    .reduce((s,r)=>s+Number(r.valor),0);
}

// ===== TELAS =====
function renderHome(){
  document.getElementById("menu").style.display="none";
  document.getElementById("paymentScreen").style.display="none";
  const s=document.getElementById("screen");
  s.style.display="block";

  s.innerHTML=`<div class="card"><h3>Bem-vindo(a)!</h3><p>Ajude fam√≠lias atrav√©s do apadrinhamento.</p></div>`;

  families.forEach(f=>{
    const percent=Math.min((f.raised/f.goal)*100,100);
    s.innerHTML+=`
      <div class="card">
        <img src="${f.image}">
        <strong>${f.name}</strong>
        <p>R$ ${f.raised} / R$ ${f.goal}</p>
        <div class="progress"><div class="progress-fill" style="width:${percent}%"></div></div>
        <button class="btn" onclick="abrirPagamento('${f.name}')">Apadrinhar</button>
      </div>`;
  });
}

function renderProfile(){
  document.getElementById("menu").style.display="none";
  document.getElementById("screen").innerHTML=`
    <div class="card">
      <h3>Meu Perfil</h3>
      <p>Email: ${usuario.email}</p>
      <p>CPF: ${cpfUsuario}</p>
      <button class="btn gray" onclick="renderHome()">‚Üê Voltar</button>
    </div>`;
}

function renderDonations(){
  document.getElementById("menu").style.display="none";
  document.getElementById("screen").innerHTML=
    `<div class="card"><h3>Doa√ß√µes</h3><p>Hist√≥rico em breve.</p></div>`;
}

// ===== TRANSPAR√äNCIA =====
function renderTransparency(){
  document.getElementById("menu").style.display="none";
  document.getElementById("paymentScreen").style.display="none";
  document.getElementById("screen").innerHTML=`
    <div class="card">
      <h3>Transpar√™ncia</h3>
      <button class="btn green" onclick="abrirSecaoRelatorio()">üìä Se√ß√£o de relat√≥rio</button>
      <button class="btn blue" onclick="emitirPDF()">üìÑ Emitir PDF</button>
    </div>`;
}

function abrirSecaoRelatorio(){
  const s=document.getElementById("screen");
  let html=`<div class="card"><h3>Relat√≥rio de Doa√ß√µes</h3></div>`;

  if(relatorio.length===0){
    html+=`<div class="card">Nenhuma doa√ß√£o registrada.</div>`;
  }else{
    relatorio.forEach(d=>{
      html+=`
        <div class="card" style="font-size:14px">
          Nome: ${d.nome}<br>
          Email: ${d.email}<br>
          CPF: ${d.cpf}<br>
          Fam√≠lia: ${d.familia}<br>
          Valor: R$ ${Number(d.valor).toFixed(2)}<br>
          Forma: ${d.forma}<br>
          Data: ${d.data}
        </div>`;
    });
  }

  html+=`<div class="card"><h3>Repasse Financeiro</h3></div>`;

  families.forEach(f=>{
    const arrec=totalArrecadadoPorFamilia(f.name);
    const rep=totalRepassadoPorFamilia(f.name);
    const saldo=arrec-rep;

    html+=`
      <div class="card" style="font-size:14px">
        <strong>${f.name}</strong><br>
        Arrecadado: R$ ${arrec.toFixed(2)}<br>
        Repassado: R$ ${rep.toFixed(2)}<br>
        Saldo dispon√≠vel: R$ ${saldo.toFixed(2)}
      </div>`;
  });

  html+=`
    <button class="btn green" onclick="registrarRepasseAutomatico()">Registrar repasse</button>
    <button class="btn gray" onclick="renderTransparency()">‚Üê Voltar</button>`;
  s.innerHTML=html;
}

// ===== REPASSE =====
function registrarRepasseAutomatico(){
  let houve=false;
  families.forEach(f=>{
    const saldo=totalArrecadadoPorFamilia(f.name)-totalRepassadoPorFamilia(f.name);
    if(saldo>0){
      repasses.push({familia:f.name,valor:saldo,forma:"Repasse financeiro",dataHora:new Date().toLocaleString("pt-BR")});
      houve=true;
    }
  });
  if(!houve){ alert("N√£o h√° saldo dispon√≠vel."); return; }
  localStorage.setItem("repasses", JSON.stringify(repasses));
  alert("Repasse registrado com sucesso.");
  abrirSecaoRelatorio();
}

// ===== PAGAMENTO =====
function abrirPagamento(nome){
  familiaAtual=nome;
  document.getElementById("screen").style.display="none";
  const p=document.getElementById("paymentScreen");
  p.style.display="block";
  p.innerHTML=`
    <div class="card">
      <h3>Forma de pagamento</h3>
      <p>${nome}</p>
      <button class="btn green" onclick="abrirPix()">üíö Pix</button>
      <button class="btn blue" onclick="abrirCartao()">üí≥ Cart√£o</button>
      <button class="btn gray" onclick="renderHome()">‚Üê Voltar</button>
    </div>`;
}

function abrirPix(){
  valorSelecionado=0;
  document.getElementById("paymentScreen").innerHTML=`
    <div class="card">
      <h3>Pix</h3>
      <div class="value-buttons">
        <button onclick="setValor(10,this)">R$ 10</button>
        <button onclick="setValor(50,this)">R$ 50</button>
        <button onclick="setValor(100,this)">R$ 100</button>
      </div>
      <input id="valorInput" type="number" placeholder="Outro valor" oninput="setValor(this.value)">
      <button class="btn green" onclick="gerarPix()">Fazer pagamento</button>
    </div>`;
}

function setValor(v,btn=null){
  valorSelecionado=Number(v)||0;
  const i=document.getElementById("valorInput");
  if(i) i.value=valorSelecionado||"";
  document.querySelectorAll(".value-buttons button").forEach(b=>b.classList.remove("active"));
  if(btn) btn.classList.add("active");
}

function gerarPix(){
  if(valorSelecionado<=0){ alert("Informe um valor"); return; }
  document.getElementById("paymentScreen").innerHTML=`
    <div class="card" style="text-align:center">
      <h3>PIX</h3>
      <img src="assets/qrcode-pix.jpg" style="width:220px;margin:16px auto">
      <button class="btn green" onclick="registrarDoacao('Pix'); sucesso()">J√° paguei</button>
    </div>`;
}

function abrirCartao(){
  registrarDoacao("Cart√£o");
  sucesso();
}

function sucesso(){
  document.getElementById("paymentScreen").innerHTML=`<div class="card" style="text-align:center">‚ù§Ô∏è Obrigado!</div>`;
  setTimeout(renderHome,2000);
}

// ===== PDF =====
function emitirPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y=10;

  pdf.setFontSize(16);
  pdf.text("Relat√≥rio de Transpar√™ncia - Zo√™",10,y);
  y+=10;

  pdf.setFontSize(12);
  pdf.text("Relat√≥rio de Doa√ß√µes",10,y);
  y+=8;

  relatorio.forEach(d=>{
    pdf.text(`Nome: ${d.nome}`,10,y);y+=6;
    pdf.text(`Email: ${d.email}`,10,y);y+=6;
    pdf.text(`CPF: ${d.cpf}`,10,y);y+=6;
    pdf.text(`Fam√≠lia: ${d.familia}`,10,y);y+=6;
    pdf.text(`Valor: R$ ${Number(d.valor).toFixed(2)}`,10,y);y+=6;
    pdf.text(`Forma: ${d.forma}`,10,y);y+=6;
    pdf.text(`Data: ${d.data}`,10,y);y+=8;
    if(y>270){ pdf.addPage(); y=10; }
  });

  pdf.addPage(); y=10;
  pdf.text("Repasse Financeiro",10,y); y+=8;

  families.forEach(f=>{
    const arrec=totalArrecadadoPorFamilia(f.name);
    const rep=totalRepassadoPorFamilia(f.name);
    const saldo=arrec-rep;
    pdf.text(f.name,10,y);y+=6;
    pdf.text(`Arrecadado: R$ ${arrec.toFixed(2)}`,10,y);y+=6;
    pdf.text(`Repassado: R$ ${rep.toFixed(2)}`,10,y);y+=6;
    pdf.text(`Saldo: R$ ${saldo.toFixed(2)}`,10,y);y+=8;
  });

  pdf.save("relatorio-transparencia-zoe.pdf");
}

// START
renderHome();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</div>
</body>
</html>
